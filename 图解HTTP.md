# 一 基础

## 1 分层

​	应用层，传输层，网络层，数据链路层。

![image-20200204213545589](%E5%9B%BE%E8%A7%A3HTTP.assets/image-20200204213545589.png)

​	利用TCP/IP协议族进行网络通信时，会通过分层顺序与对方进行通信。发送端从应用层往下走，接收端则往应用层往上走。

​	我们用HTTP举例来说明，首先作为发送端的客户端在应用层（HTTP协议）发出一个想看某个Web页面的HTTP请求。

​	接着，为了传输方便，在传输层（TCP协议）把从应用层处收到的数据（HTTP请求报文）进行分割，并在各个报文上打上标记序号及端口号后转发给网络层。

​	在网络层（IP协议），增加作为通信目的地的MAC地址后转发给链路层。这样一来，发往网络的通信请求就准备齐全了。

​	接收端的服务器在链路层接收到数据，按序往上层发送，一直到应用层。当传输到应用层，才能算真正接收到由客户端发送过来的HTTP请求。

![image-20200204213802663](%E5%9B%BE%E8%A7%A3HTTP.assets/image-20200204213802663.png)

### 1.1 负责传输的IP协议

​	位于网络层。	

​	在满足各类条件的情况下，将各种数据包传送给对方。

​	最重要的两个条件：

1. IP地址：指明了节点被分配到的地址。（可变），可以和MAC地址进行配对。
2. MAC地址：网卡所属的固定地址。（基本不改变）

​	IP间的通信依赖MAC地址。ARP协议是一种用以解析地址的协议，根据通信方的IP地址可以反查出对应的MAC地址。

​	路由选择：类比快递流程，每个节点只需知道来源与去路，也即无论哪台计算机哪台网络设备均无法全面掌握互联网中的细节。

![image-20200205141219602](%E5%9B%BE%E8%A7%A3HTTP.assets/image-20200205141219602.png)

### 1.2 确保可靠性的TCP协议

​	位于传输层，提供字节流服务。

​	字节流服务：将大块数据分割成以**报文段**为单位的数据包进行管理。

​	**TCP协议为了更容易传送大数据才把数据分割，并且TCP协议可以确认数据最终是否送达对方。**

​	三次握手：握手过程使用了TCP的标志：SYN与ACK。

1. 发送端首先发送一个带SYN标志的数据包给对方。
2. 接收端收到后，回传一个带有SYN/ACK标志的数据包以示传达确认信息
3. 最后，发送端再回传一个带ACK标志的数据包，代表握手结束。

注意：若在握手过程中的某个阶段莫名中断，TCP协议会再次以相同的顺序发送相同数据包。

![image-20200205141824554](%E5%9B%BE%E8%A7%A3HTTP.assets/image-20200205141824554.png)

### 1.3 负责域名解析的DNS服务

​	处于应用层。提供域名到IP地址之间的解析服务。

​	![image-20200205142417657](%E5%9B%BE%E8%A7%A3HTTP.assets/image-20200205142417657.png)

### 总结：一图了解一次通信过程中各协议发挥的作用

![image-20200205142623187](%E5%9B%BE%E8%A7%A3HTTP.assets/image-20200205142623187.png)

## 2 URI与URL

### 2.1 统一资源标识符 URI

​	 由某个协议方案表示的资源的定位标识符。协议方案指资源所使用的协议类型名称（HTTP等）。

​	URI用字符串标识某一互联网资源，而URL表示资源的地点（互联网上所处的位置），URL是URI的子集。

#### 1.URI格式

​	表示指定的URI，要使用涵盖全部必要信息的绝对URI，绝对URL及相对URL。

​	相对URL指浏览器中基本URI处指定的URL，如：/image/cy.gif。

​	绝对URI的格式：

![image-20200205161554588](%E5%9B%BE%E8%A7%A3HTTP.assets/image-20200205161554588.png)

1. 登录信息（可选）
2. 服务器地址，待访问的服务器地址。
3. 服务器端口号，指定服务器连接的网络端口号（可选）
4. 带层次的文件路径，要访问的资源
5. 查询字符串，（可选）
6. 片段标识符 （可选）

# 二 简单的HTTP协议

​	完成服务器端与客户端之间的通信，可区别哪端是谁。

​	通过请求与响应的交换达成通信。

## 1 请求与响应报文组成

![image-20200210124624793](%E5%9B%BE%E8%A7%A3HTTP.assets/image-20200210124624793.png)

![image-20200210124722734](%E5%9B%BE%E8%A7%A3HTTP.assets/image-20200210124722734.png)

## 2 HTTP是一种不保存状态的协议

​	自身不对请求与响应之间的通信状态进行保存。

​	为了实现期望的保存状态功能，引入了Cookie技术。

## 3 请求URI定位资源

​	指定URI的方法

![image-20200210140858673](%E5%9B%BE%E8%A7%A3HTTP.assets/image-20200210140858673.png)

## 4 告知服务器意图的HTTP方法

1. get 获取资源
2. post 传输实体主体
3. put 传输文件
4. head 获取报文首部  用于确认URI的有效性及资源更新的日期时间等。
5. delete 删除文件   按请求URI删除指定文件
6. options 询问网站对于请求的URI指定的资源trace支持的方法
7. trace 让服务器端将之前的请求通信环回给客户端的方法，可能引发跨站追踪攻击，不常用![image-20200210142041763](%E5%9B%BE%E8%A7%A3HTTP.assets/image-20200210142041763.png)
8. connect 要求用隧道协议连接代理![image-20200210142210775](%E5%9B%BE%E8%A7%A3HTTP.assets/image-20200210142210775.png)



![image-20200210142314995](%E5%9B%BE%E8%A7%A3HTTP.assets/image-20200210142314995.png)

## 5 持久连接节省流量

​	持久连接  只要任一端没有明确提出断开连接，则保持TCP连接状态![image-20200210153310412](%E5%9B%BE%E8%A7%A3HTTP.assets/image-20200210153310412.png)

​	好处在于减少了TCP连接的重复建立与断开造成的额外开销，减轻了服务器端的负载。同时减少开销的那段时间，使HTTP请求和响应能够更早结束，web页面显示速度提高。

​	持久连接使得多数请求以管线化方式发送称为可能。

![image-20200210153649944](%E5%9B%BE%E8%A7%A3HTTP.assets/image-20200210153649944.png)

## 6 使用Cookie的状态管理

​	Cookie技术通过在请求和响应中写入Cookie信息来控制客户端的状态。

​	![image-20200210154832263](%E5%9B%BE%E8%A7%A3HTTP.assets/image-20200210154832263.png)

![image-20200210154851009](%E5%9B%BE%E8%A7%A3HTTP.assets/image-20200210154851009.png)

![image-20200210155910541](%E5%9B%BE%E8%A7%A3HTTP.assets/image-20200210155910541.png)

# 三 HTTP报文内的HTTP信息

## 1 HTTP报文

​	用于HTTP协议交互的信息。

​	请求报文与响应报文。

​	HTTP报文大致可分为报文首部与报文主体两块。两者由最初出现的空行分割。通常并不一定要有报文主体。

![image-20200210160557655](%E5%9B%BE%E8%A7%A3HTTP.assets/image-20200210160557655.png)

报文结构

![image-20200210161830696](%E5%9B%BE%E8%A7%A3HTTP.assets/image-20200210161830696.png)

![image-20200210161849810](%E5%9B%BE%E8%A7%A3HTTP.assets/image-20200210161849810.png)

![image-20200210161931029](%E5%9B%BE%E8%A7%A3HTTP.assets/image-20200210161931029.png)

## 2 编码提高传输效率

​	![image-20200210210446882](%E5%9B%BE%E8%A7%A3HTTP.assets/image-20200210210446882.png)

​	分割发送的分块传输编码  传送大容量的数据时，通过将数据分割成多块，可以让浏览器逐步显示页面。

![image-20200210210849226](%E5%9B%BE%E8%A7%A3HTTP.assets/image-20200210210849226.png)

## 3 发送多种数据的多部分对象集合

​	发送的一份报文主体内可含有多类型实体。

​	多部分对象集合包含对象：

● multipart/form-data   在Web表单文件上传时使用。

● multipart/byteranges   状态码206（Partial Content，部分内容）响应报文包含了多个范围的内容时使用。

在HTTP报文中使用多部分对象集合时，需要在首部字段里加上Content-type

例：

![image-20200210211759817](%E5%9B%BE%E8%A7%A3HTTP.assets/image-20200210211759817.png)

![image-20200210211816234](%E5%9B%BE%E8%A7%A3HTTP.assets/image-20200210211816234.png)

![image-20200210211828637](%E5%9B%BE%E8%A7%A3HTTP.assets/image-20200210211828637.png)





## 4 获取部分内容的范围请求（比如下载到一半的内容断网，再次下载可以接着上一次的）

​	![image-20200210211425134](%E5%9B%BE%E8%A7%A3HTTP.assets/image-20200210211425134.png)

byte范围：

1. a-b  范围
2. a-  a到之后所有
3. -a   从一开始到a
4. a-b，c-d   多重范围



​	对于范围请求，响应会返回状态码为206 Partial Content的响应报文。对于多重范围请求，则会在首部字段Content-Type标明multipart/byteranges后返回响应报文。

​	若无法响应范围，则返回状态码200 OK和完整的实体内容。

## 5 内容协商

​	指客户端与服务器端就响应内容进行交涉，然后提供给客户端最适合资源，内容协商会以响应资源的语言、字符集、编码方式等作为判断的基准。

​	包含在请求报文中的某些首部字段就是判断基准，如：

![image-20200210212357416](%E5%9B%BE%E8%A7%A3HTTP.assets/image-20200210212357416.png)

​	内容协商技术有：

1. 服务器驱动协商（Server-driven Negotiation）  由服务器端进行内容协商。以请求的首部字段为参考，在服务器端自动处理。但对用户来说，以浏览器发送的信息作为判定的依据，并不一定能筛选出最优内容。
2. 客户端驱动协商（Agent-driven Negotiation）  由客户端进行内容协商的方式。用户从浏览器显示的可选项列表中手动选择。还可以利用JavaScript脚本在Web页面上自动进行上述选择。比如按OS的类型或浏览器类型，自行切换成PC版页面或手机版页面。
3. 透明协商（Transparent Negotiation）   是服务器驱动和客户端驱动的结合体，是由服务器端和客户端各自进行内容协商的一种方法。

# 四 返回结果的HTTP状态码





